# 数学题答案解析 - 技术设计

## Context

- 项目为新建能力：后端 Go + langchaingo，前端 Vue 3，无既有业务系统依赖。
- 需求要点：上传题目图片（含截图）或输入文字 → 得到分步文字解析 + 与步骤一一对应的多张讲解图；公式全链路 LaTeX、前端统一渲染；UI 交互友好。
- 约束：首版不限制题型，配图以模型生成为主；讲解视频作为后续待办，本期不实现。

## Goals / Non-Goals

**Goals:**

- 实现题目输入（上传图片 + 文字）、识图转文本、分步解析生成、步骤对应讲解图生成、结果展示（一步一文一图 + 公式渲染 + 步骤导航与图片放大）。
- 全链路公式以 LaTeX 表示与传递，前端用统一渲染器（如 KaTeX）保证正确、不乱码。
- 后端使用 Go + langchaingo；前端 Vue 3，注重入口清晰、错误可恢复、加载状态明确。

**Non-Goals:**

- 本期不实现「拍照」入口（仅上传 + 文字）。
- 本期不实现讲解视频生成与播放；视频方案见下文「后续待办：讲解视频」。
- 不限制题型，故不针对某类题型做专用程序化绘图，首版以通用模型生成图为主。

## Decisions

### 1. 题目文本统一入口

- **决策**：无论上传图片还是输入文字，后端均以「题目文本」（含 LaTeX 公式）为唯一输入进入解析流水线；图片先经识图转为该文本。
- **理由**：解析、配图、展示都基于同一份结构化题目，逻辑简单、可复现、易扩展。
- **备选**：图片直传解析端做多模态理解；放弃统一文本会增加下游分支与一致性难度，故不采用。

### 2. 识图能力选型

- **决策**：采用多模态大模型（或带视觉的 API）做「图 → 题目文本」，公式要求模型以 LaTeX 输出。
- **理由**：手写、排版、公式混排识别效果好于纯 OCR，且与现有 LLM 技术栈一致。
- **备选**：专用 OCR + 公式识别；若成本或延迟优先，可后续替换为 OCR 管线。

### 3. 解析与步骤结构

- **决策**：大模型一次（或两次）调用输出「分步解析」结构化数据：步骤序列，每步含标题/简述、正文（Markdown + LaTeX）、以及可选的配图描述/类型，便于下游按步生成图。
- **理由**：步骤化是 spec 要求（一步一图），结构化输出便于前端展示与后续视频 Phase 2 的时间轴对齐。
- **数据形状**：步骤列表，每项含 `title`、`content`（含 LaTeX）、`imagePrompt` 或等价字段（用于生成该步讲解图）。

### 4. 讲解图生成

- **决策**：首版以文生图/多模态生成为主，按步骤依次生成：每步用该步的 `imagePrompt`（或步骤摘要）调用绘图 API，得到一张图并与步骤 ID 绑定。
- **理由**：不限制题型时，程序化绘图覆盖成本高；模型生成可快速支持多题型，优先保证「多张、与步骤对应」。
- **备选**：部分题型（如函数图像）后续可增加程序化绘图或混合方案。

### 5. 公式表示与前端渲染

- **决策**：全链路使用 LaTeX；API 与存储只传 LaTeX 字符串（或 Markdown 内嵌 `$...$` / `$$...$$`）；前端使用 KaTeX（或 MathJax）做唯一渲染源。
- **理由**：单一格式 + 单一渲染器可最大程度避免乱码与不一致；KaTeX 轻量、服务端渲染可选。
- **备选**：MathML 或图片公式；LaTeX 更通用、易与 LLM 输出对齐。

### 6. 异步与长耗时

- **决策**：若单次解析+配图总耗时较长（如 >5–10s），采用「提交任务 → 轮询或 WebSocket 查状态 → 结果就绪后展示」的异步模式；前端展示明确加载状态与进度提示。
- **理由**：避免 HTTP 长轮询超时、提升可感知的响应与错误处理。
- **备选**：同步等待；仅在耗时可接受时采用。

### 7. 前后端职责划分

- **决策**：后端负责识图、解析生成、配图生成、任务状态与结果存储；前端负责输入、上传、结果展示（步骤列表、文字、图、公式渲染）、步骤导航、图片放大、错误与加载态。
- **理由**：与 proposal 及三份 capability（problem-input、explanation-generation、explanation-display）一致，边界清晰。

### 8. 大模型配置分离

- **决策**：为不同用途的大模型/能力提供**独立配置**，便于按场景切换模型、调参与鉴权，互不干扰。
  - **OCR 识图**：单独配置（如 `ocr` 或 `vision`），用于「图片 → 题目文本」；可包含模型标识、API 端点、Key、超时、重试等。
  - **LLM 题目解析**：单独配置（如 `llm.explanation`），用于分步解析生成；可包含模型、端点、Key、temperature、max_tokens、system prompt 路径等。
  - **视频生成**：单独配置（如 `video`），用于 Phase 2 讲解视频（TTS、合成参数等）；本期可只预留配置结构，不接入调用。
- **形式**：使用**统一配置文件内分块**（单一 YAML 文件，如 `config/models.yaml`），内含 `ocr`、`llm`、`video` 等块，由应用启动时加载并注入对应模块。
- **理由**：OCR、解析、视频可能对应不同厂商或模型，分离配置便于运维与 A/B；敏感信息（Key）建议环境变量覆盖或密钥服务注入。

---

## 后续待办：讲解视频（Phase 2）

以下方案写入设计，**本期不实现**，作为后续待办。

- **目标**：将已生成的多张步骤讲解图合成为一段连贯的讲解视频。
- **思路**：
  - 输入：步骤序列 + 每步对应图片 + 每步建议展示时长（可由解析阶段或默认规则给出）。
  - 合成：使用 FFmpeg 将图片序列按时长与转场（如淡入淡出）合成视频；可选增加 TTS 旁白（由步骤文字生成语音并混流）。
  - 连贯性：严格按步骤顺序排列画面；时间轴与步骤一一对应；转场与时长一致即可保证观感连贯。
- **依赖**：本期需保证步骤与配图一一对应且顺序稳定，以便 Phase 2 直接复用同一数据结构与资源。
- **实现要点**：后端 Go 调用 FFmpeg（子进程或库）；若做 TTS，需脚本/时长对齐与混流逻辑。

---

## Risks / Trade-offs

| 风险 | 缓解 |
|------|------|
| 大模型输出步骤或 LaTeX 不稳定 | Prompt 规范 + 输出格式约束（JSON/Markdown）；必要时解析后校验与重试。 |
| 配图与步骤语义偏差 | 每步使用该步摘要或专用 imagePrompt；可加「步骤类型」提示（代数/几何等）提升相关性。 |
| 识图对模糊或非数学图失败 | 明确错误提示 +「重新上传」「改为输入文字」入口；必要时限制单张大小与格式。 |
| 解析+多图生成总耗时长 | 异步任务 + 进度/状态展示；可考虑步骤图并行生成以缩短等待。 |
| 成本（多模态 + 多轮生成） | 首版以体验与正确性为主；后续可对高频题型做缓存或降级策略。 |

## 大模型配置文件结构（统一配置文件分块）

使用**单一配置文件**（如 `config/models.yaml`），内部分块对应 OCR、LLM 题目解析、视频生成；应用启动时加载该文件，按块注入识图、解析、视频等模块。实际字段名可在实现时微调。

```yaml
# OCR 识图：图片 → 题目文本
ocr:
  provider: ""          # 如 openai / 火山 / 自建
  model: ""             # 视觉模型名
  api_base: ""
  api_key_env: ""       # 从环境变量读取 Key 的变量名
  timeout_sec: 30
  max_retries: 2

# LLM 题目解析：题目文本 → 分步解析
llm:
  explanation:
    provider: ""
    model: ""
    api_base: ""
    api_key_env: ""
    temperature: 0.3
    max_tokens: 4096
    system_prompt_file: ""  # 可选：外部 prompt 文件

# 视频生成（Phase 2 后续待办）
video:
  tts_provider: ""      # 可选 TTS 厂商
  tts_model: ""
  ffmpeg_bin: "ffmpeg"
  default_step_duration_sec: 5
```

实现时从该统一配置文件读取 `ocr`、`llm`、`video` 各块，分别注入对应模块，不在代码中写死。

## Migration Plan

- 本项目为全新能力，无存量迁移。
- 部署：后端服务与前端分别构建部署；**大模型配置**通过配置文件或环境变量提供（OCR、LLM、视频分块）；若使用异步任务，需部署任务存储与轮询/WebSocket 端点。
- 回滚：按服务/前端版本回滚即可；无数据迁移故无专门回滚数据步骤。

## Open Questions

- 识图与绘图具体选用哪家 API（如同一家多模态模型还是分开的识图 + 文生图），需结合可用性与成本在实现阶段定夺。
- 步骤图是否允许并行生成（并发调用绘图 API），取决于限流与稳定性，可在实现时试验后定。
